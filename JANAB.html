<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher Portal — Tanbeeh & Tashjeeh</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #c9a574;
    --primary-dark: #a98251;
    --success: #2e7d32;
    --warning: #e04b4b;
    --gray: #cbd5e0;
    --shadow: 0 20px 50px rgba(0,0,0,0.35);
    --card-shadow: 0 10px 30px rgba(0,0,0,0.25);
  }

  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Poppins', sans-serif;
    min-height: 100vh;
    padding: 15px 10px;
    color: white;
    
    /* Same background + blur as login page */
    background: url("https://i.ibb.co/1Jw8zpzX/Lingmala.jpg") center/cover no-repeat fixed;
    position: relative;
  }

  /* Dark overlay + blur */
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(8px);
    z-index: -1;
  }

  .container { max-width: 1100px; margin: 0 auto; }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
    animation: fadeInDown 0.9s ease;
  }

  .logo img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 5px solid rgba(255,255,255,0.5);
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    object-fit: contain;
    background: white;
    padding: 8px;
  }

  .title-group {
    text-align: center;
  }

  h1 {
    font-size: 34px;
    color: white;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 4px 10px rgba(0,0,0,0.4);
  }

  .subtitle {
    color: #f0f0f0;
    font-size: 16px;
    font-weight: 500;
    margin-top: 6px;
  }

  /* Glass Cards */
  .card {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 28px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.25);
    animation: fadeInUp 0.8s ease;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #ffffff;
    font-size: 15px;
  }

  select, input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid rgba(255,255,255,0.35);
    border-radius: 16px;
    font-size: 15px;
    background: rgba(255,255,255,0.2);
    color: white;
    transition: all 0.3s ease;
  }

  select option { background: #333; color: white; }

  select:focus, input:focus {
    outline: none;
    border-color: white;
    background: rgba(255,255,255,0.3);
    box-shadow: 0 0 0 4px rgba(255,255,255,0.2);
  }

  input::placeholder { color: #ddd; }

  .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 14px;
    margin-top: 10px;
  }

  button {
    padding: 14px 22px;
    border: none;
    border-radius: 16px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    min-width: 150px;
  }

  .btn-primary { 
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
    color: white; 
  }
  .btn-danger { 
    background: linear-gradient(135deg, #e04b4b, #c82333); 
    color: white; 
  }
  .btn-secondary { 
    background: rgba(255,255,255,0.25); 
    color: white; 
    border: 1px solid rgba(255,255,255,0.4);
  }

  button:hover { 
    transform: translateY(-4px); 
    box-shadow: 0 14px 30px rgba(0,0,0,0.45); 
  }

  .message { 
    padding: 16px 20px; 
    border-radius: 16px; 
    margin: 15px 0; 
    font-weight: 600; 
    font-size: 15px; 
    animation: slideIn 0.5s ease; 
    backdrop-filter: blur(10px);
  }
  .success { background: rgba(46,125,50,0.3); border: 1px solid rgba(46,125,50,0.6); }
  .warn { background: rgba(230,74,25,0.3); border: 1px solid rgba(230,74,25,0.6); color: #ffccbc; }

  .table-container {
    overflow-x: auto;
    border-radius: 20px;
    box-shadow: var(--card-shadow);
    margin-top: 10px;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
  }

  table { width: 100%; border-collapse: collapse; font-size: 14.5px; }
  th {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 16px 12px;
    text-transform: uppercase;
    font-size: 13px;
    letter-spacing: 0.5px;
  }

  td { padding: 14px 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.15); color: white; }
  tr:hover td { background: rgba(255,255,255,0.1); }
  .tan { background: rgba(198,40,40,0.3) !important; }
  .tash { background: rgba(46,125,50,0.3) !important; }
  .total-positive { color: #a8e6a8; font-weight: 700; }
  .total-negative { color: #ff8a80; font-weight: 700; }

  .history-card h2 {
    font-size: 24px;
    color: white;
    margin-bottom: 15px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
  }

  .history-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    flex-wrap: wrap; 
    gap: 12px; 
    margin-bottom: 15px; 
  }

  .log-tanbeeh { background: rgba(198,40,40,0.2); }
  .log-tashjeeh { background: rgba(46,125,50,0.2); }
  .teacher-name { color: #c9a574; font-weight: 600; }
  .timestamp { color: #ccc; font-size: 12.5px; }

  @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

  @media (max-width: 600px) {
    .header { gap: 14px; }
    .logo img { width: 80px; height: 80px; }
    h1 { font-size: 28px; }
    .card { padding: 20px; }
    .form-grid { grid-template-columns: 1fr; }
    button { width: 100%; }
  }
</style>
</head>
<body>

<div class="container">

  <!-- Header with Logo + Title -->
  <div class="header">
    <div class="logo">
      <img src="https://i.ibb.co/Ndqj258K/panchgani-removebg-preview.png" alt="Logo">
    </div>
    <div class="title-group">
      <h1>Teacher Portal</h1>
      <p class="subtitle">Tanbeeh & Tashjeeh Management System</p>
    </div>
  </div>

  <!-- Form Card -->
  <div class="card">
    <div class="form-grid">
      <div class="form-group">
        <label>Student</label>
        <select id="studentNo"></select>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="type">
          <option value="Tanbeeh">Tanbeeh</option>
          <option value="Tashjeeh">Tashjeeh</option>
        </select>
      </div>
      <div class="form-group">
        <label>Reason</label>
        <select id="item"></select>
      </div>
      <div class="form-group">
        <label>Teacher Name</label>
        <input type="text" id="teacherName" placeholder="Enter your name" required />
      </div>
    </div>

    <div class="btn-group">
      <button id="addPts" class="btn-primary">Add Points</button>
      <button id="resetStudent" class="btn-danger">Reset Student</button>
      <button id="showParentBtn" class="btn-secondary">Parent Sheet</button>
      <button id="syncFromSheetsBtn" class="btn-secondary">Sync</button>
    </div>
  </div>

  <div id="message"></div>

  <!-- Points Table Card -->
  <div class="card">
    <div class="table-container">
      <table id="pointsTable">
        <thead>
          <tr><th>No.</th><th>Name</th><th class="tan">Tanbeeh</th><th class="tash">Tashjeeh</th><th>Total</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- History Card -->
  <div class="card history-card">
    <div class="history-header">
      <h2>Activity Log</h2>
      <button id="clearHistoryBtn" class="btn-danger">Clear Local Log</button>
    </div>
    <div class="table-container">
      <table class="history-table" id="historyTable">
        <thead>
          <tr><th>Date & Time</th><th>Student</th><th>Type</th><th>Reason</th><th>Points</th><th>Added By</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxC06GlxFqVYDMX7Tfjxyx-nbUYwIEL5fu0CDy3RjEydqco8lV-bEpmiDHKK3guf_yt/exec";
const STORAGE_KEY = 'tanbeehTashjeehPoints_v2';
const HISTORY_KEY = 'tanbeehTashjeehHistory_v2';

/* ===========================
   NAMES — now dynamic
   (removed hard-coded array)
   =========================== */
let studentNames = [];

const tanbeehData = [{text:"Khidmat Guzaro ni taazem ma farq paru che",pts:10},{text:"Bad kalam che, Gaali bolva ni adat che",pts:5},{text:"taheez ma pota na quran nai lauta",pts:2},{text:"Khidmatguzaar, staff, farzando sathe sulook barabar nathi",pts:2},{text:"Sareqat kidi che",pts:10},{text:"jhoot bole che",pts:2},{text:"Building ma farzando sathe jhagro kare che",pts:3},{text:"Nizaam mutabiq amal karva ma be farag nazar ave che (Taujih karva baad)",pts:1},{text:"Tilawat Al-Dua ma potani Qiraat/Dua ni tilawat na kidi",pts:3},{text:"ghair mumasib shakelt si kapda pehne che (Taujih karva baad)",pts:2},{text:"Baghair raza jagah par electronic gadgets rakhe che",pts:3},{text:"Launday ma kapda nathi apta",pts:5},{text:"Tahfeez ma takheer si hazir thaye che (Taujih karva baad)",pts:4},{text:"Tilawat Al-Dua ma Dua ni Tilawat ma ghair hazir hata",pts:2},{text:"Namaz ma masallo lai ne nathi aya (per namaz)",pts:1},{text:"Namaz ma ghair hazir rahe che (per day)",pts:5},{text:"azan aapwa waste gair hazir hata",pts:5},{text:"MHD equipments nesambhalwa ma faraq kido che",Pts:1},{text:"Room ma cricket ya e misal ni games rame che",pts:3},{text:"Room ni lights, fan band nathi kidi",pts:2},{text:"Libaas ni nazafat nathi rakhata (Taujih karva bad)",pts:2},{text:"Mohta baal rakhe che (Taujih karva bad)",pts:3},{text:"Raate tilawat Al-Qasaid ma ghair hazir rahe che (Weekly)",pts:3},{text:"Tilawat al-Qasaid ma takheer si ave che",pts:1},{text:"Bed par chadar nathi",pts:2},{text:"Bed par kapda kitabo ya bags muke che",pts:2}];

const tashjeehData = [{text:"Active participation in sports event (Weekly)",pts:2},{text:"Active participation in vocal practice (Weekly)",pts:2},{text:"Active performance in Events; Participation in Internal Events",pts:1},{text:"Actively assists in winding up and maintaining cleanliness",pts:2},{text:"Balancing Academics and Sports",pts:2},{text:"Bimar farzand ne pareegva gaya",pts:2},{text:"Class test ma performance achu che",pts:3},{text:"Teamwork in academic projects",pts:5},{text:"Consistently follows instructions with care and accuracy",pts:7},{text:"Duo ni tilawat kare che (Weekly)",pts:3},{text:"Ek mahina ma 10 si 14 Safahat na darmiyaan jaeed hifz",pts:5},{text:"Ek mahina ma 15 si 20 Safahat na darmiyaan jaeed hifz",pts:10},{text:"Fajar ni namaz baad tul u shams lag masail par bethi ne duo parhwani aadat",pts:3},{text:"Fajr ni Namaz ma 100% Hazri che (Weekly)",pts:5},{text:"Ghana behtar andaz ma takbeera dida che",pts:3},{text:"Ghani behtar andaz ma azan didi che",pts:2},{text:"Habitually reads periodicals and stays aware",pts:5},{text:"Hafiz che ane hifz mazboot rakhe (Weekly)",pts:7},{text:"Has achieved success in external exams",pts:3},{text:"Performed well in skits/quiz/stage program",pts:3},{text:"library ma si kitabo lai ne parhwa ni adat (daily)",pts:3},{text:"Majlis ma behtar shakelet si tilawat kidi che",pts:1},{text:"Maktabat na kitabao ma si daily reading",pts:5},{text:"Marhala na ikhtebaar ma kamyab thaya che",pts:20},{text:"muhafiz je tasks aape che ehne behtar shakelet si kare che (Weekly)",pts:3},{text:"Nahna darajah na farzand ne 'bhai' kahi ne bulave che",pts:2}];

let points = JSON.parse(localStorage.getItem(STORAGE_KEY)) || Array(studentNames.length).fill().map(()=>({tanbeeh:0,tashjeeh:0}));
let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];

const studentSelect = document.getElementById('studentNo');
const typeSelect = document.getElementById('type');
const itemSelect = document.getElementById('item');
const teacherNameInput = document.getElementById('teacherName');
const addBtn = document.getElementById('addPts');
const resetStudentBtn = document.getElementById('resetStudent');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');
const messageDiv = document.getElementById('message');
const tableBody = document.querySelector('#pointsTable tbody');
const historyBody = document.querySelector('#historyTable tbody');
const showParentBtn = document.getElementById('showParentBtn');
const syncFromSheetsBtn = document.getElementById('syncFromSheetsBtn');

/* ---------------- LOAD STUDENT NAMES FROM SHEETS ---------------- */
async function loadStudentNames() {
  try {
    const res = await fetch(`${SHEET_WEB_APP_URL}?action=getNames`);
    if (!res.ok && res.status !== 0) throw new Error('Network response was not ok');
    const names = await res.json();
    studentNames = Array.isArray(names) ? names : [];
    // ensure points state matches new names length
    if (!points || points.length !== studentNames.length) {
      points = Array(studentNames.length).fill().map(()=>({tanbeeh:0,tashjeeh:0}));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
    }
  } catch (err) {
    console.log("Could not load student names from Google Sheets:", err);
  }
}

// Initialize from Google Sheets on page load
function initFromGoogleSheets() {
  // Get points from Google Sheets
  fetch(`${SHEET_WEB_APP_URL}?action=getPoints`)
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.text();
    })
    .then(text => {
      try {
        const sheetsPoints = JSON.parse(text);
        if (sheetsPoints && sheetsPoints.length === studentNames.length) {
          points = sheetsPoints;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
          renderTable();
          console.log("Loaded points from Google Sheets");
        } else if (sheetsPoints && sheetsPoints.length > 0 && studentNames.length === 0) {
          // fallback if names not loaded yet: set points length to sheetsPoints length
          points = sheetsPoints;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
          renderTable();
        }
      } catch (e) {
        console.log("Could not parse points from Google Sheets:", e);
      }
    })
    .catch(err => console.log("Could not load points from Google Sheets:", err));
  
  // Get history from Google Sheets
  fetch(`${SHEET_WEB_APP_URL}?action=getHistory`)
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.text();
    })
    .then(text => {
      try {
        const sheetsHistory = JSON.parse(text);
        if (sheetsHistory && sheetsHistory.length > 0) {
          history = sheetsHistory;
          localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
          renderHistory();
          console.log("Loaded history from Google Sheets");
        }
      } catch (e) {
        console.log("Could not parse history from Google Sheets:", e);
      }
    })
    .catch(err => console.log("Could not load history from Google Sheets:", err));
}

// Sync to Google Sheets - Only ADD, not overwrite
function syncToGoogleSheets(studentId, type, pointsToAdd, reasonText, teacher) {
  // Send ADD action for points
  fetch(SHEET_WEB_APP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      action: "add",
      data: {
        studentId: studentId,
        type: type,
        points: pointsToAdd
      }
    })
  }).catch(err => console.log("Error syncing points:", err));
  
  // Also add to history
  const now = new Date();
  const timeStr = now.toLocaleString('en-GB', {day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'});
  
  fetch(SHEET_WEB_APP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      action: "addHistory",
      data: {
        time: timeStr,
        studentId: studentId,
        type: type,
        reason: reasonText,
        points: pointsToAdd,
        teacher: teacher
      }
    })
  }).catch(err => console.log("Error syncing history:", err));
}

// Manually sync from Google Sheets
function syncFromSheets() {
  showMsg("Syncing from Google Sheets...", 'success');
  initFromGoogleSheets();
  setTimeout(() => {
    showMsg("Sync complete! Local data updated from Google Sheets.", 'success');
  }, 1000);
}

function populateStudents(){
  studentSelect.innerHTML = '<option value="">Select Student</option>';
  studentNames.forEach((name, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${i+1}. ${name}`;
    studentSelect.appendChild(opt);
  });
}

function updateItems(){
  const data = typeSelect.value === 'Tanbeeh' ? tanbeehData : tashjeehData;
  itemSelect.innerHTML = '<option value="">Select Reason</option>';
  data.forEach((it, idx) => {
    const o = document.createElement('option');
    o.value = idx;
    o.textContent = `${it.text} (+${it.pts} pts)`;
    itemSelect.appendChild(o);
  });
}

function renderTable(){
  tableBody.innerHTML = '';
  points.forEach((p, i) => {
    const total = p.tashjeeh - p.tanbeeh;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td style="text-align:left;max-width:220px;word-wrap:break-word;">${studentNames[i] || '—'}</td><td class="tan">${p.tanbeeh}</td><td class="tash">${p.tashjeeh}</td><td class="${total >= 0 ? 'total-positive' : 'total-negative'}"><strong>${total}</strong></td>`;
    tableBody.appendChild(tr);
  });
}

function renderHistory(){
  historyBody.innerHTML = '';
  if (history.length === 0) {
    historyBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ccc;padding:30px;font-size:15px;">No activity recorded yet</td></tr>';
    return;
  }
  history.slice().reverse().forEach(log => {
    const shortName = (studentNames[log.studentId] || '').split(' ').slice(0,4).join(' ') + ((studentNames[log.studentId] || '').split(' ').length > 4 ? '...' : '');
    const tr = document.createElement('tr');
    tr.className = log.type === 'Tanbeeh' ? 'log-tanbeeh' : 'log-tashjeeh';
    tr.innerHTML = `<td class="timestamp">${log.time}</td><td>${shortName || log.studentName || '—'}</td><td><strong>${log.type}</strong></td><td style="max-width:230px;word-wrap:break-word;">${log.reason}</td><td><strong>${log.type === 'Tanbeeh' ? '-' : '+'}${log.points}</td><td class="teacher-name">${log.teacher}</td>`;
    historyBody.appendChild(tr);
  });
}

function showMsg(txt, type = 'success'){
  messageDiv.innerHTML = `<div class="message ${type}">${txt}</div>`;
  setTimeout(() => messageDiv.innerHTML = '', 5000);
}

function addLogEntry(studentId, type, reason, points, teacher) {
  const now = new Date();
  const timeStr = now.toLocaleString('en-GB', {day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'});
  history.push({ time: timeStr, studentId, type, reason, points, teacher: teacher.trim() || "Unknown" });
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  renderHistory();
}

addBtn.onclick = () => {
  const studentId = parseInt(studentSelect.value);
  const type = typeSelect.value;
  const itemIdx = parseInt(itemSelect.value);
  const teacher = teacherNameInput.value.trim();

  if (isNaN(studentId)) return showMsg('Please select a student', 'warn');
  if (isNaN(itemIdx)) return showMsg('Please select a reason', 'warn');
  if (!teacher) return showMsg('Please enter your name', 'warn');

  const data = type === 'Tanbeeh' ? tanbeehData : tashjeehData;
  const pts = data[itemIdx].pts;
  const reasonText = data[itemIdx].text;

  // Update local storage
  if(type === 'Tanbeeh') points[studentId].tanbeeh += pts;
  else points[studentId].tashjeeh += pts;

  localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
  addLogEntry(studentId, type, reasonText, pts, teacher);
  renderTable();
  showMsg(`${pts} pts (${type}) added for ${ (studentNames[studentId] || 'Student') .split(' ')[0]} by ${teacher}`);
  
  // Sync to Google Sheets (ADD only)
  syncToGoogleSheets(studentId, type, pts, reasonText, teacher);

  teacherNameInput.value = '';
  itemSelect.value = '';
};

resetStudentBtn.onclick = () => {
  if(!confirm('Reset this student points to zero? (Local only - Google Sheets will keep previous points)')) return;
  const idx = parseInt(studentSelect.value);
  if (isNaN(idx)) return showMsg('Select a student first', 'warn');
  points[idx] = {tanbeeh:0, tashjeeh:0};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
  renderTable();
  showMsg(`${studentNames[idx] || 'Student'} points reset locally (Google Sheets unchanged)`, 'warn');
  // NO syncToGoogleSheets() here - Sheets keeps the data!
};

clearHistoryBtn.onclick = () => {
  if (history.length === 0) return showMsg('Log is already empty', 'warn');
  if (confirm('Delete ALL local activity log? (Google Sheets history will remain)')) {
    history = [];
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
    showMsg('Local activity log cleared (Google Sheets unchanged)', 'warn');
  }
};

typeSelect.onchange = updateItems;
showParentBtn.onclick = () => window.open(SHEET_WEB_APP_URL, '_blank');
syncFromSheetsBtn.onclick = syncFromSheets;

// Initialize on page load
window.addEventListener('DOMContentLoaded', async () => {
  await loadStudentNames();
  populateStudents();
  updateItems();
  initFromGoogleSheets(); // Load from Sheets first
  renderTable();
  renderHistory();
});
</script>
</body>
</html>
