<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Teacher Portal â€” Advanced Tanbeeh & Tashjeeh Analytics</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #c9a574; --primary-dark: #a98251; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
  --dark: #0f172a; --gray-800: #1e293b; --gray-600: #475569; --gray-400: #94a3b8; --gray-200: #e2e8f0;
  --text-light: #f8fafc; --text-medium: #cbd5e1; --text-dark: #94a3b8;
  --glass-bg: rgba(255, 255, 255, 0.08); --glass-border: rgba(255, 255, 255, 0.15);
  --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5); --shadow-md: 0 10px 25px rgba(0, 0, 0, 0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
body {
  min-height: 100vh; color: var(--text-light); background: 
    radial-gradient(circle at 20% 80%, rgba(201, 165, 116, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
    url("https://i.ibb.co/1Jw8zpzX/Lingmala.jpg") center/cover no-repeat fixed;
  position: relative; overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0;
  background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.95));
  backdrop-filter: blur(8px); z-index: -1;
}
.bg-shapes { position: fixed; inset: 0; z-index: -1; overflow: hidden; }
.shape {
  position: absolute; border-radius: 50%; background: radial-gradient(circle, var(--primary), transparent);
  opacity: 0.1; animation: float 20s infinite linear;
}
.shape:nth-child(1) { width: 300px; height: 300px; top: 10%; left: 5%; }
.shape:nth-child(2) { width: 200px; height: 200px; top: 60%; right: 10%; animation-delay: 5s; animation-duration: 25s; }
@keyframes float { 0%,100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(180deg); } }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
.header {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; padding: 20px;
  background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-md); flex-wrap: wrap; gap: 20px;
}
.logo-container { display: flex; align-items: center; gap: 20px; }
.logo { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255, 255, 255, 0.3); overflow: hidden; background: white; padding: 8px; }
.logo img { width: 100%; height: 100%; object-fit: contain; }
.title-group h1 { 
  font-size: 2rem; font-weight: 700; 
  background: linear-gradient(to right, #fbbf24, var(--primary)); 
  -webkit-background-clip: text; 
  -webkit-text-fill-color: transparent;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}
.subtitle { color: var(--gray-200); font-size: 0.95rem; font-weight: 400; }
.stats-bar { display: flex; gap: 15px; flex-wrap: wrap; }
.stat-item { display: flex; flex-direction: column; align-items: center; padding: 10px 15px; background: rgba(255, 255, 255, 0.08); border-radius: 12px; min-width: 90px; }
.stat-value { font-size: 1.8rem; font-weight: 700; color: var(--primary); text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
.stat-label { font-size: 0.8rem; color: var(--gray-200); font-weight: 500; }
.dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
.card {
  background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 20px; padding: 25px;
  border: 1px solid var(--glass-border); box-shadow: var(--shadow-md); transition: all 0.3s ease;
}
.card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); border-color: rgba(255, 255, 255, 0.3); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
.card-title { font-size: 1.3rem; font-weight: 600; color: var(--text-light); display: flex; align-items: center; gap: 10px; }
.card-title i { color: var(--primary); }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
.form-group { position: relative; }
.form-label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-light); font-size: 0.95rem; }
.form-control {
  width: 100%; padding: 14px 16px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 12px;
  font-size: 0.95rem; background: rgba(255, 255, 255, 0.1); color: var(--text-light); transition: all 0.3s ease;
}
.form-control:focus { 
  outline: none; border-color: var(--primary); background: rgba(255, 255, 255, 0.15); 
  box-shadow: 0 0 0 3px rgba(201, 165, 116, 0.3); color: var(--text-light);
}
.form-control::placeholder { color: var(--gray-400); }
.form-control option { background: var(--dark); color: var(--text-light); }
.btn-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
.btn {
  padding: 14px 24px; border: none; border-radius: 12px; font-weight: 600; font-size: 0.95rem; cursor: pointer;
  transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; min-width: 150px;
}
.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
.btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
.btn-danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
.btn-secondary { background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3); }
.btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
.quick-actions { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
.action-btn {
  padding: 12px 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px; color: var(--text-light); font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease;
  display: flex; align-items: center; gap: 8px;
}
.action-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
.table-container { 
  overflow-x: auto; border-radius: 16px; margin-top: 10px; 
  background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
}
.table { width: 100%; border-collapse: collapse; font-size: 0.9rem; color: var(--text-light); }
.table th {
  background: linear-gradient(135deg, rgba(201, 165, 116, 0.8), rgba(169, 130, 81, 0.8)); color: white;
  padding: 16px 12px; text-transform: uppercase; font-size: 0.8rem; font-weight: 600; text-align: left;
}
.table td { 
  padding: 14px 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
  color: var(--text-light); vertical-align: middle; 
}
.table tr:hover td { background: rgba(255, 255, 255, 0.05); }
.tan-cell { 
  background: rgba(239, 68, 68, 0.15) !important; 
  color: #fecaca !important; 
  font-weight: 600; 
}
.tash-cell { 
  background: rgba(16, 185, 129, 0.15) !important; 
  color: #a7f3d0 !important; 
  font-weight: 600; 
}
.total-positive { color: #86efac; font-weight: 700; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); } 
.total-negative { color: #fca5a5; font-weight: 700; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); }
.search-container { position: relative; margin-bottom: 20px; }
.search-input {
  width: 100%; padding: 14px 45px 14px 20px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.2);
  background: rgba(255, 255, 255, 0.1); color: var(--text-light); font-size: 0.95rem;
}
.search-input::placeholder { color: var(--gray-400); }
.search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--gray-400); }
.tabs { display: flex; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 20px; flex-wrap: wrap; }
.tab { 
  padding: 12px 24px; background: transparent; border: none; 
  color: var(--gray-400); font-weight: 500; cursor: pointer; 
  border-bottom: 3px solid transparent; transition: all 0.3s ease;
}
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab:hover:not(.active) { color: var(--text-light); }
.tab-content { display: none; }
.tab-content.active { display: block; }
.modal { 
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
  background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; 
}
.modal-content {
  background: var(--dark); border-radius: 20px; padding: 30px; width: 90%; max-width: 500px;
  border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: var(--shadow-lg);
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-title { font-size: 1.4rem; font-weight: 600; color: var(--text-light); }
.modal-close { background: none; border: none; color: var(--gray-400); font-size: 1.5rem; cursor: pointer; }
.modal-close:hover { color: var(--text-light); }
.notification {
  position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; 
  color: white; font-weight: 500; z-index: 1001; box-shadow: var(--shadow-md); 
  display: flex; align-items: center; gap: 12px; transform: translateX(150%); 
  transition: transform 0.4s ease; max-width: 350px;
}
.notification.show { transform: translateX(0); }
.notification.success { background: linear-gradient(135deg, var(--success), #059669); border-left: 5px solid #059669; }
.notification.warning { background: linear-gradient(135deg, var(--danger), #dc2626); border-left: 5px solid #dc2626; }
.notification.info { background: linear-gradient(135deg, var(--info), #2563eb); border-left: 5px solid #1d4ed8; }
.chart-container { height: 300px; width: 100%; margin-top: 20px; }
.analytics-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
.time-range-btn {
  padding: 8px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px; color: var(--text-light); font-size: 0.85rem; cursor: pointer; transition: all 0.2s ease;
}
.time-range-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
.time-range-btn:hover:not(.active) { background: rgba(255, 255, 255, 0.2); }
.chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
.chart-stat { display: flex; gap: 15px; flex-wrap: wrap; }
.chart-stat-item { 
  display: flex; flex-direction: column; align-items: center; padding: 8px 12px; 
  background: rgba(255, 255, 255, 0.05); border-radius: 8px; min-width: 80px; 
}
.chart-stat-value { font-size: 1.2rem; font-weight: 700; color: var(--text-light); }
.chart-stat-label { font-size: 0.75rem; color: var(--gray-200); }
.live-indicator {
  display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(239, 68, 68, 0.2);
  border-radius: 12px; font-size: 0.75rem; color: #fca5a5; animation: pulse 2s infinite;
}
.live-dot { width: 6px; height: 6px; background: #ef4444; border-radius: 50%; animation: blink 1.5s infinite; }
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
@keyframes pulse { 
  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 
  70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 
  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
}

/* Custom Scrollbar */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

@media (max-width: 768px) {
  .container { padding: 15px; } 
  .dashboard { grid-template-columns: 1fr; } 
  .btn { width: 100%; min-width: auto; }
  .form-grid { grid-template-columns: 1fr; } 
  .header { flex-direction: column; text-align: center; }
  .title-group h1 { font-size: 1.6rem; } 
  .card-header { flex-direction: column; align-items: flex-start; }
  .chart-header { flex-direction: column; align-items: flex-start; } 
  .analytics-controls { justify-content: center; }
  .stats-bar { justify-content: center; }
  .table { font-size: 0.85rem; }
}
</style>
</head>
<body>

<div class="bg-shapes">
  <div class="shape"></div>
  <div class="shape"></div>
</div>

<div id="notificationArea"></div>

<div id="studentDetailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Student Details</h3>
      <button class="modal-close" onclick="closeModal('studentDetailsModal')">&times;</button>
    </div>
    <div id="studentDetailsContent"></div>
  </div>
</div>

<div id="bulkActionsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Bulk Actions</h3>
      <button class="modal-close" onclick="closeModal('bulkActionsModal')">&times;</button>
    </div>
    <div id="bulkActionsContent">
      <div class="form-group">
        <label class="form-label">Action Type</label>
        <select id="bulkActionType" class="form-control">
          <option value="tanbeeh">Apply Tanbeeh to Selected</option>
          <option value="tashjeeh">Apply Tashjeeh to Selected</option>
          <option value="reset">Reset Selected Students</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Reason</label>
        <select id="bulkReason" class="form-control"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Teacher Name</label>
        <input type="text" id="bulkTeacherName" class="form-control" placeholder="Enter your name">
      </div>
      <div class="btn-group" style="margin-top: 25px;">
        <button id="applyBulkAction" class="btn btn-primary">Apply to Selected</button>
        <button class="btn btn-secondary" onclick="closeModal('bulkActionsModal')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <header class="header">
    <div class="logo-container">
      <div class="logo">
        <img src="https://i.ibb.co/Ndqj258K/panchgani-removebg-preview.png" alt="Logo">
      </div>
      <div class="title-group">
        <h1>Teacher Portal</h1>
        <p class="subtitle">Advanced Tanbeeh & Tashjeeh Analytics System</p>
      </div>
    </div>
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-value" id="totalStudents">0</span>
        <span class="stat-label">Students</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="totalTanbeeh">0</span>
        <span class="stat-label">Tanbeeh</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="totalTashjeeh">0</span>
        <span class="stat-label">Tashjeeh</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="netPoints">0</span>
        <span class="stat-label">Net Points</span>
      </div>
    </div>
  </header>

  <div class="dashboard">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-plus-circle"></i> Add Points</h3>
        <div class="quick-actions">
          <button class="action-btn" onclick="openModal('bulkActionsModal')"><i class="fas fa-users"></i> Bulk Actions</button>
        </div>
      </div>
      <div class="card-content">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Student</label>
            <select id="studentNo" class="form-control"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Type</label>
            <select id="type" class="form-control">
              <option value="Tanbeeh">Tanbeeh</option>
              <option value="Tashjeeh">Tashjeeh</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Reason</label>
            <select id="item" class="form-control"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Teacher Name</label>
            <input type="text" id="teacherName" class="form-control" placeholder="Enter your name" required>
          </div>
        </div>
        <div class="btn-group">
          <button id="addPts" class="btn btn-primary"><i class="fas fa-plus"></i> Add Points</button>
          <button id="resetStudent" class="btn btn-danger"><i class="fas fa-undo"></i> Reset Student</button>
          <button id="syncFromSheetsBtn" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Sync Now</button>
        </div>
        <div class="quick-actions" style="margin-top: 20px;">
          <button class="action-btn" onclick="showTopPerformers()"><i class="fas fa-trophy"></i> Top Performers</button>
          <button class="action-btn" onclick="showNeedsAttention()"><i class="fas fa-exclamation-triangle"></i> Needs Attention</button>
          <button class="action-btn" onclick="exportData()"><i class="fas fa-download"></i> Export Data</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Statistics</h3>
      </div>
      <div class="card-content">
        <div class="stats-bar" style="justify-content: space-between;">
          <div class="stat-item">
            <span class="stat-value" id="avgTanbeeh">0</span>
            <span class="stat-label">Avg. Tanbeeh</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="avgTashjeeh">0</span>
            <span class="stat-label">Avg. Tashjeeh</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="positiveStudents">0</span>
            <span class="stat-label">Positive</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="negativeStudents">0</span>
            <span class="stat-label">Needs Work</span>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <div class="form-label">Recent Activity</div>
          <div id="recentActivity" style="margin-top: 10px; max-height: 150px; overflow-y: auto; color: var(--text-medium);"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="search-container">
    <input type="text" id="searchInput" class="search-input" placeholder="Search students by name...">
    <div class="search-icon"><i class="fas fa-search"></i></div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('students')">Students</button>
    <button class="tab" onclick="switchTab('history')">Activity Log</button>
    <button class="tab" onclick="switchTab('analytics')">Analytics</button>
  </div>

  <div id="studentsTab" class="tab-content active">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-users"></i> Student Points Overview</h3>
        <div class="quick-actions">
          <button class="action-btn" onclick="selectAllStudents()"><i class="fas fa-check-square"></i> Select All</button>
          <button class="action-btn" onclick="deselectAllStudents()"><i class="fas fa-square"></i> Deselect All</button>
        </div>
      </div>
      <div class="card-content">
        <div class="table-container">
          <table class="table" id="pointsTable">
            <thead>
              <tr>
                <th style="width: 50px;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                <th>No.</th>
                <th>Name</th>
                <th class="tan-cell">Tanbeeh</th>
                <th class="tash-cell">Tashjeeh</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="historyTab" class="tab-content">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-history"></i> Activity Log</h3>
        <div class="quick-actions">
          <button id="clearHistoryBtn" class="action-btn"><i class="fas fa-trash"></i> Clear Log</button>
          <button class="action-btn" onclick="filterLog('all')"><i class="fas fa-filter"></i> All</button>
          <button class="action-btn" onclick="filterLog('tanbeeh')"><i class="fas fa-minus-circle"></i> Tanbeeh</button>
          <button class="action-btn" onclick="filterLog('tashjeeh')"><i class="fas fa-plus-circle"></i> Tashjeeh</button>
        </div>
      </div>
      <div class="card-content">
        <div class="table-container">
          <table class="table history-table" id="historyTable">
            <thead>
              <tr>
                <th>Date & Time</th>
                <th>Student</th>
                <th>Type</th>
                <th>Reason</th>
                <th>Points</th>
                <th>Added By</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="analyticsTab" class="tab-content">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-chart-pie"></i> Analytics Dashboard</h3>
        <div class="live-indicator" id="liveIndicator">
          <div class="live-dot"></div> LIVE
        </div>
      </div>
      <div class="card-content">
        <div class="card" style="margin-bottom: 25px;">
          <div class="chart-header">
            <h3 class="card-title" style="margin: 0;"><i class="fas fa-chart-line"></i> Points Trend</h3>
            <div class="analytics-controls">
              <button class="time-range-btn active" onclick="changeTimeRange('7d')">7 Days</button>
              <button class="time-range-btn" onclick="changeTimeRange('30d')">30 Days</button>
              <button class="time-range-btn" onclick="changeTimeRange('90d')">90 Days</button>
              <button class="time-range-btn" onclick="changeTimeRange('all')">All Time</button>
            </div>
          </div>
          <div class="card-content">
            <div class="chart-container">
              <canvas id="pointsTrendChart"></canvas>
            </div>
            <div class="chart-stat">
              <div class="chart-stat-item">
                <span class="chart-stat-value" id="trendTanbeeh">0</span>
                <span class="chart-stat-label">Total Tanbeeh</span>
              </div>
              <div class="chart-stat-item">
                <span class="chart-stat-value" id="trendTashjeeh">0</span>
                <span class="chart-stat-label">Total Tashjeeh</span>
              </div>
              <div class="chart-stat-item">
                <span class="chart-stat-value" id="trendNet">0</span>
                <span class="chart-stat-label">Net Change</span>
              </div>
              <div class="chart-stat-item">
                <span class="chart-stat-value" id="trendAvg">0</span>
                <span class="chart-stat-label">Avg/Day</span>
              </div>
            </div>
          </div>
        </div>

        <div class="dashboard" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); margin-bottom: 25px;">
          <div class="card">
            <div class="chart-header">
              <h3 class="card-title" style="margin: 0;"><i class="fas fa-chart-pie"></i> Distribution</h3>
              <button class="action-btn" onclick="toggleChartType()"><i class="fas fa-exchange-alt"></i> Switch</button>
            </div>
            <div class="card-content">
              <div class="chart-container">
                <canvas id="distributionChart"></canvas>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="chart-header">
              <h3 class="card-title" style="margin: 0;"><i class="fas fa-chart-bar"></i> Hourly Activity</h3>
            </div>
            <div class="card-content">
              <div class="chart-container">
                <canvas id="hourlyChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="dashboard" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Top Tanbeeh Reasons</h3>
            </div>
            <div class="card-content">
              <div id="topTanbeehReasons" style="margin-top: 10px; max-height: 250px; overflow-y: auto;"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-award"></i> Top Tashjeeh Reasons</h3>
            </div>
            <div class="card-content">
              <div id="topTashjeehReasons" style="margin-top: 10px; max-height: 250px; overflow-y: auto;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// JavaScript remains the same as previous version, just updating text colors in JavaScript-generated content
const SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxC06GlxFqVYDMX7Tfjxyx-nbUYwIEL5fu0CDy3RjEydqco8lV-bEpmiDHKK3guf_yt/exec";
const STORAGE_KEY = 'tanbeehTashjeehPoints_v4';
const HISTORY_KEY = 'tanbeehTashjeehHistory_v4';

let studentNames = [], points = [], history = [], selectedStudents = new Set(), filteredHistory = [];
let charts = {}, currentTimeRange = '7d', chartType = 'doughnut';

const tanbeehData = [
  {text:"Khidmat Guzaro ni taazem ma farq paru che",pts:10},{text:"Bad kalam che, Gaali bolva ni adat che",pts:5},
  {text:"taheez ma pota na quran nai lauta",pts:2},{text:"Khidmatguzaar, staff, farzando sathe sulook barabar nathi",pts:2},
  {text:"Sareqat kidi che",pts:10},{text:"jhoot bole che",pts:2},{text:"Building ma farzando sathe jhagro kare che",pts:3},
  {text:"Nizaam mutabiq amal karva ma be farag nazar ave che (Taujih karva baad)",pts:1},
  {text:"Tilawat Al-Dua ma potani Qiraat/Dua ni tilawat na kidi",pts:3},{text:"ghair mumasib shakelt si kapda pehne che (Taujih karva baad)",pts:2},
  {text:"Baghair raza jagah par electronic gadgets rakhe che",pts:3},{text:"Launday ma kapda nathi apta",pts:5},
  {text:"Tahfeez ma takheer si hazir thaye che (Taujih karva baad)",pts:4},{text:"Tilawat Al-Dua ma Dua ni Tilawat ma ghair hazir hata",pts:2},
  {text:"Namaz ma masallo lai ne nathi aya (per namaz)",pts:1},{text:"Namaz ma ghair hazir rahe che (per day)",pts:5},
  {text:"azan aapwa waste gair hazir hata",pts:5},{text:"MHD equipments nesambhalwa ma faraq kido che",pts:1},
  {text:"Room ma cricket ya e misal ni games rame che",pts:3},{text:"Room ni lights, fan band nathi kidi",pts:2},
  {text:"Libaas ni nazafat nathi rakhata (Taujih karva bad)",pts:2},{text:"Mohta baal rakhe che (Taujih karva bad)",pts:3},
  {text:"Raate tilawat Al-Qasaid ma ghair hazir rahe che (Weekly)",pts:3},{text:"Tilawat al-Qasaid ma takheer si ave che",pts:1},
  {text:"Bed par chadar nathi",pts:2},{text:"Bed par kapda kitabo ya bags muke che",pts:2}
];
const tashjeehData = [
  {text:"Active participation in sports event (Weekly)",pts:2},{text:"Active participation in vocal practice (Weekly)",pts:2},
  {text:"Active performance in Events; Participation in Internal Events",pts:1},{text:"Actively assists in winding up and maintaining cleanliness",pts:2},
  {text:"Balancing Academics and Sports",pts:2},{text:"Bimar farzand ne pareegva gaya",pts:2},{text:"Class test ma performance achu che",pts:3},
  {text:"Teamwork in academic projects",pts:5},{text:"Consistently follows instructions with care and accuracy",pts:7},
  {text:"Duo ni tilawat kare che (Weekly)",pts:3},{text:"Ek mahina ma 10 si 14 Safahat na darmiyaan jaeed hifz",pts:5},
  {text:"Ek mahina ma 15 si 20 Safahat na darmiyaan jaeed hifz",pts:10},{text:"Fajar ni namaz baad tul u shams lag masail par bethi ne duo parhwani aadat",pts:3},
  {text:"Fajr ni Namaz ma 100% Hazri che (Weekly)",pts:5},{text:"Ghana behtar andaz ma takbeera dida che",pts:3},
  {text:"Ghani behtar andaz ma azan didi che",pts:2},{text:"Habitually reads periodicals and stays aware",pts:5},
  {text:"Hafiz che ane hifz mazboot rakhe (Weekly)",pts:7},{text:"Has achieved success in external exams",pts:3},
  {text:"Performed well in skits/quiz/stage program",pts:3},{text:"library ma si kitabo lai ne parhwa ni adat (daily)",pts:3},
  {text:"Majlis ma behtar shakelet si tilawat kidi che",pts:1},{text:"Maktabat na kitabao ma si daily reading",pts:5},
  {text:"Marhala na ikhtebaar ma kamyab thaya che",pts:20},{text:"muhafiz je tasks aape che ehne behtar shakelet si kare che (Weekly)",pts:3},
  {text:"Nahna darajah na farzand ne 'bhai' kahi ne bulave che",pts:2}
];

const studentSelect = document.getElementById('studentNo'), typeSelect = document.getElementById('type'), itemSelect = document.getElementById('item');
const teacherNameInput = document.getElementById('teacherName'), addBtn = document.getElementById('addPts'), resetStudentBtn = document.getElementById('resetStudent');
const clearHistoryBtn = document.getElementById('clearHistoryBtn'), syncFromSheetsBtn = document.getElementById('syncFromSheetsBtn');
const searchInput = document.getElementById('searchInput'), selectAllCheckbox = document.getElementById('selectAllCheckbox');
const pointsTableBody = document.querySelector('#pointsTable tbody'), historyTableBody = document.querySelector('#historyTable tbody');

window.addEventListener('DOMContentLoaded', async () => {
  await loadStudentNames();
  populateStudents();
  updateItems();
  initFromGoogleSheets();
  updateStatistics();
  renderTable();
  renderHistory();
  setupEventListeners();
  setupCharts();
  startLiveUpdates();
  const savedTeacherName = localStorage.getItem('teacherName');
  if (savedTeacherName) teacherNameInput.value = savedTeacherName;
  setInterval(syncFromSheets, 5 * 60 * 1000);
});

async function loadStudentNames() {
  try {
    showNotification("Loading student data...", "info");
    const res = await fetch(`${SHEET_WEB_APP_URL}?action=getNames&t=${Date.now()}`);
    if (!res.ok && res.status !== 0) throw new Error('Network response was not ok');
    const names = await res.json();
    studentNames = Array.isArray(names) ? names : [];
    if (!points || points.length !== studentNames.length) {
      points = Array(studentNames.length).fill().map(() => ({tanbeeh: 0, tashjeeh: 0}));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
    }
    showNotification(`Loaded ${studentNames.length} students`, "success");
  } catch (err) {
    console.error("Could not load student names:", err);
    showNotification("Could not load student names. Using local data.", "warning");
    if (points && points.length > 0) studentNames = points.map((_, i) => `Student ${i+1}`);
  }
}

function initFromGoogleSheets() {
  fetch(`${SHEET_WEB_APP_URL}?action=getPoints&t=${Date.now()}`)
    .then(response => response.ok ? response.text() : Promise.reject())
    .then(text => {
      try {
        const sheetsPoints = JSON.parse(text);
        if (sheetsPoints && sheetsPoints.length === studentNames.length) {
          points = sheetsPoints;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
          renderTable();
          updateStatistics();
          updateCharts();
          console.log("Loaded points from Google Sheets");
        }
      } catch (e) { console.log("Could not parse points from Google Sheets:", e); }
    })
    .catch(err => console.log("Could not load points from Google Sheets:", err));
  
  fetch(`${SHEET_WEB_APP_URL}?action=getHistory&t=${Date.now()}`)
    .then(response => response.ok ? response.text() : Promise.reject())
    .then(text => {
      try {
        const sheetsHistory = JSON.parse(text);
        if (sheetsHistory && sheetsHistory.length > 0) {
          history = sheetsHistory;
          localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
          renderHistory();
          updateRecentActivity();
          updateCharts();
          console.log("Loaded history from Google Sheets");
        }
      } catch (e) { console.log("Could not parse history from Google Sheets:", e); }
    })
    .catch(err => console.log("Could not load history from Google Sheets:", err));
}

function syncToGoogleSheets(studentId, type, pointsToAdd, reasonText, teacher) {
  localStorage.setItem('teacherName', teacher);
  fetch(SHEET_WEB_APP_URL, {
    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: "add", data: { studentId, type, points: pointsToAdd } })
  }).catch(err => console.log("Error syncing points:", err));
  
  const now = new Date();
  const timeStr = now.toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  
  fetch(SHEET_WEB_APP_URL, {
    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: "addHistory", data: { time: timeStr, studentId, type, reason: reasonText, points: pointsToAdd, teacher } })
  }).catch(err => console.log("Error syncing history:", err));
}

function syncFromSheets() {
  showNotification("Syncing from Google Sheets...", "info");
  initFromGoogleSheets();
  setTimeout(() => showNotification("Sync complete! Local data updated.", "success"), 1500);
}

function populateStudents() {
  studentSelect.innerHTML = '<option value="">Select Student</option>';
  studentNames.forEach((name, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${i+1}. ${name}`;
    studentSelect.appendChild(opt);
  });
  document.getElementById('totalStudents').textContent = studentNames.length;
}

function updateItems() {
  const data = typeSelect.value === 'Tanbeeh' ? tanbeehData : tashjeehData;
  itemSelect.innerHTML = '<option value="">Select Reason</option>';
  data.forEach((it, idx) => {
    const o = document.createElement('option');
    o.value = idx;
    o.textContent = `${it.text} (+${it.pts} pts)`;
    itemSelect.appendChild(o);
  });
  const bulkReasonSelect = document.getElementById('bulkReason');
  if (bulkReasonSelect) {
    bulkReasonSelect.innerHTML = '<option value="">Select Reason</option>';
    data.forEach((it, idx) => {
      const o = document.createElement('option');
      o.value = idx;
      o.textContent = `${it.text} (+${it.pts} pts)`;
      bulkReasonSelect.appendChild(o);
    });
  }
}

function renderTable() {
  pointsTableBody.innerHTML = '';
  let totalTanbeeh = 0, totalTashjeeh = 0, positiveStudents = 0, negativeStudents = 0;
  
  points.forEach((p, i) => {
    const total = p.tashjeeh - p.tanbeeh;
    totalTanbeeh += p.tanbeeh;
    totalTashjeeh += p.tashjeeh;
    if (total >= 0) positiveStudents++; else negativeStudents++;
    const studentName = studentNames[i] || `Student ${i+1}`;
    const isSelected = selectedStudents.has(i);
    const statusClass = total >= 0 ? 'total-positive' : 'total-negative';
    const statusText = total >= 0 ? 'Positive' : 'Needs Work';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleStudentSelection(${i}, this)"></td>
      <td>${i+1}</td>
      <td style="text-align:left; cursor:pointer;" onclick="showStudentDetails(${i})"><strong style="color: var(--text-light)">${studentName}</strong></td>
      <td class="tan-cell">${p.tanbeeh}</td>
      <td class="tash-cell">${p.tashjeeh}</td>
      <td class="${statusClass}"><strong>${total}</strong></td>
      <td><span style="padding: 6px 12px; background: ${total >= 0 ? 'rgba(16,185,129,0.2)' : 'rgba(239,68,68,0.2)'}; border-radius: 20px; font-size: 0.8rem; color: ${total >= 0 ? '#86efac' : '#fca5a5'};">${statusText}</span></td>
      <td>
        <button class="action-btn" onclick="quickAddPoints(${i}, 'Tanbeeh')" title="Quick Tanbeeh"><i class="fas fa-minus-circle"></i></button>
        <button class="action-btn" onclick="quickAddPoints(${i}, 'Tashjeeh')" title="Quick Tashjeeh"><i class="fas fa-plus-circle"></i></button>
      </td>
    `;
    pointsTableBody.appendChild(tr);
  });
  
  document.getElementById('totalTanbeeh').textContent = totalTanbeeh;
  document.getElementById('totalTashjeeh').textContent = totalTashjeeh;
  document.getElementById('netPoints').textContent = totalTashjeeh - totalTanbeeh;
  document.getElementById('positiveStudents').textContent = positiveStudents;
  document.getElementById('negativeStudents').textContent = negativeStudents;
  document.getElementById('avgTanbeeh').textContent = studentNames.length > 0 ? Math.round(totalTanbeeh / studentNames.length) : 0;
  document.getElementById('avgTashjeeh').textContent = studentNames.length > 0 ? Math.round(totalTashjeeh / studentNames.length) : 0;
}

function renderHistory() {
  historyTableBody.innerHTML = '';
  const displayHistory = filteredHistory.length > 0 ? filteredHistory : history;
  
  if (displayHistory.length === 0) {
    historyTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--gray-400);"><i class="fas fa-history" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>No activity recorded yet</td></tr>`;
    return;
  }
  
  displayHistory.slice().reverse().forEach((log, index) => {
    const studentName = studentNames[log.studentId] || `Student ${log.studentId+1}`;
    const shortName = studentName.split(' ').slice(0, 3).join(' ') + (studentName.split(' ').length > 3 ? '...' : '');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="timestamp" style="color: var(--text-medium)">${log.time}</td>
      <td><strong style="color: var(--text-light)">${shortName}</strong></td>
      <td><span style="padding: 4px 8px; background: ${log.type === 'Tanbeeh' ? 'rgba(239,68,68,0.2)' : 'rgba(16,185,129,0.2)'}; border-radius: 12px; font-size: 0.8rem; color: ${log.type === 'Tanbeeh' ? '#fca5a5' : '#86efac'};">${log.type}</span></td>
      <td style="max-width: 200px; word-wrap: break-word; color: var(--text-medium)">${log.reason}</td>
      <td><strong style="color: ${log.type === 'Tanbeeh' ? '#fca5a5' : '#86efac'}">${log.type === 'Tanbeeh' ? '-' : '+'}${log.points}</strong></td>
      <td class="teacher-name" style="color: var(--text-medium)">${log.teacher}</td>
      <td><button class="action-btn" onclick="undoAction(${history.length - 1 - index})" title="Undo"><i class="fas fa-undo"></i></button></td>
    `;
    historyTableBody.appendChild(tr);
  });
}

function updateRecentActivity() {
  const recentActivityDiv = document.getElementById('recentActivity');
  if (!recentActivityDiv) return;
  recentActivityDiv.innerHTML = '';
  const recent = history.slice(-5).reverse();
  if (recent.length === 0) {
    recentActivityDiv.innerHTML = '<div style="color: var(--gray-400); text-align: center; padding: 10px;">No recent activity</div>';
    return;
  }
  recent.forEach(log => {
    const studentName = studentNames[log.studentId] || `Student ${log.studentId+1}`;
    const shortName = studentName.split(' ')[0];
    const timeAgo = getTimeAgo(log.time);
    const activityDiv = document.createElement('div');
    activityDiv.style.cssText = `padding: 8px 12px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid ${log.type === 'Tanbeeh' ? '#ef4444' : '#10b981'}; font-size: 0.85rem;`;
    activityDiv.innerHTML = `
      <div style="display: flex; justify-content: space-between;">
        <div><strong style="color: var(--text-light)">${shortName}</strong> <span style="color: ${log.type === 'Tanbeeh' ? '#fca5a5' : '#a7f3d0'}">${log.type === 'Tanbeeh' ? '-' : '+'}${log.points} ${log.type}</span></div>
        <div style="color: var(--gray-400); font-size: 0.8rem;">${timeAgo}</div>
      </div>
      <div style="color: var(--text-medium); margin-top: 4px; font-size: 0.8rem;">${log.reason.substring(0, 40)}${log.reason.length > 40 ? '...' : ''}</div>
    `;
    recentActivityDiv.appendChild(activityDiv);
  });
}

function getTimeAgo(timeString) {
  const now = new Date();
  const logTime = new Date(timeString);
  if (isNaN(logTime.getTime())) return timeString;
  const diffMs = now - logTime;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return logTime.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function showNotification(message, type = 'info') {
  const notificationArea = document.getElementById('notificationArea');
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  let icon = 'fa-info-circle';
  if (type === 'success') icon = 'fa-check-circle';
  if (type === 'warning') icon = 'fa-exclamation-triangle';
  notification.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
  notificationArea.appendChild(notification);
  setTimeout(() => notification.classList.add('show'), 10);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 400);
  }, 5000);
}

function showStudentDetails(studentId) {
  const studentName = studentNames[studentId] || `Student ${studentId+1}`;
  const studentPoints = points[studentId];
  const total = studentPoints.tashjeeh - studentPoints.tanbeeh;
  const studentHistory = history.filter(log => log.studentId === studentId);
  const modalContent = document.getElementById('studentDetailsContent');
  modalContent.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h4 style="color: var(--primary); margin-bottom: 10px;">${studentName}</h4>
      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div class="stat-item"><span class="stat-value" style="color: #ef4444;">${studentPoints.tanbeeh}</span><span class="stat-label">Tanbeeh</span></div>
        <div class="stat-item"><span class="stat-value" style="color: #10b981;">${studentPoints.tashjeeh}</span><span class="stat-label">Tashjeeh</span></div>
        <div class="stat-item"><span class="stat-value" style="color: ${total >= 0 ? '#10b981' : '#ef4444'}">${total}</span><span class="stat-label">Total</span></div>
      </div>
    </div>
    <div style="margin-bottom: 20px;">
      <div class="form-label">Recent Activity</div>
      <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
        ${studentHistory.length > 0 ? studentHistory.slice(-5).reverse().map(log => `
          <div style="padding: 8px 12px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between;"><span style="color: ${log.type === 'Tanbeeh' ? '#fca5a5' : '#a7f3d0'}">${log.type}</span><span style="color: var(--gray-400); font-size: 0.8rem;">${log.time}</span></div>
            <div style="margin-top: 4px; font-size: 0.9rem; color: var(--text-medium)">${log.reason}</div><div style="margin-top: 4px; color: var(--gray-400); font-size: 0.8rem;">By: ${log.teacher}</div>
          </div>`).join('') : '<div style="color: var(--gray-400); text-align: center; padding: 10px;">No activity recorded</div>'}
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="quickAddPoints(${studentId}, 'Tanbeeh'); closeModal('studentDetailsModal')"><i class="fas fa-minus-circle"></i> Add Tanbeeh</button>
      <button class="btn btn-success" onclick="quickAddPoints(${studentId}, 'Tashjeeh'); closeModal('studentDetailsModal')"><i class="fas fa-plus-circle"></i> Add Tashjeeh</button>
    </div>`;
  openModal('studentDetailsModal');
}

function quickAddPoints(studentId, type) {
  studentSelect.value = studentId;
  typeSelect.value = type;
  updateItems();
  itemSelect.focus();
  showNotification(`Ready to add ${type} for ${studentNames[studentId] || 'Student'}`, 'info');
}

function showStudentHistory(studentId) {
  filteredHistory = history.filter(log => log.studentId === studentId);
  switchTab('history');
  renderHistory();
  showNotification(`Showing history for ${studentNames[studentId] || 'Student'}`, 'info');
}

function filterLog(type) {
  if (type === 'all') filteredHistory = [];
  else filteredHistory = history.filter(log => type === 'tanbeeh' ? log.type === 'Tanbeeh' : log.type === 'Tashjeeh');
  renderHistory();
  showNotification(`Showing ${type === 'all' ? 'all' : type} activities`, 'info');
}

function toggleStudentSelection(studentId, checkbox) {
  if (checkbox.checked) selectedStudents.add(studentId); else selectedStudents.delete(studentId);
  updateSelectAllCheckbox();
}

function selectAllStudents() {
  for (let i = 0; i < studentNames.length; i++) selectedStudents.add(i);
  renderTable();
}

function deselectAllStudents() {
  selectedStudents.clear();
  renderTable();
}

function toggleSelectAll() {
  if (selectAllCheckbox.checked) selectAllStudents(); else deselectAllStudents();
}

function updateSelectAllCheckbox() {
  selectAllCheckbox.checked = selectedStudents.size === studentNames.length && studentNames.length > 0;
  selectAllCheckbox.indeterminate = selectedStudents.size > 0 && selectedStudents.size < studentNames.length;
}

function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`${tabName}Tab`).classList.add('active');
  if (tabName === 'analytics') setTimeout(updateCharts, 100);
}

function updateStatistics() {
  renderTable();
  updateRecentActivity();
}

function undoAction(historyIndex) {
  const logEntry = history[historyIndex];
  if (!logEntry) return;
  if (confirm(`Undo ${logEntry.type} of ${logEntry.points} points for ${studentNames[logEntry.studentId] || 'student'}?`)) {
    if (logEntry.type === 'Tanbeeh') points[logEntry.studentId].tanbeeh -= logEntry.points;
    else points[logEntry.studentId].tashjeeh -= logEntry.points;
    history.splice(historyIndex, 1);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    renderTable();
    renderHistory();
    updateRecentActivity();
    updateCharts();
    showNotification(`Undid ${logEntry.type} action`, 'success');
  }
}

function showTopPerformers() {
  const performers = points.map((p, i) => ({ id: i, name: studentNames[i] || `Student ${i+1}`, score: p.tashjeeh - p.tanbeeh })).sort((a, b) => b.score - a.score).slice(0, 5);
  let message = "<strong style='color: var(--text-light)'>Top 5 Performers:</strong><br>";
  performers.forEach((p, i) => message += `${i+1}. ${p.name}: <span class="total-positive">${p.score}</span><br>`);
  showNotification(message, 'info');
}

function showNeedsAttention() {
  const performers = points.map((p, i) => ({ id: i, name: studentNames[i] || `Student ${i+1}`, score: p.tashjeeh - p.tanbeeh })).sort((a, b) => a.score - b.score).slice(0, 5);
  let message = "<strong style='color: var(--text-light)'>Needs Attention:</strong><br>";
  performers.forEach((p, i) => {
    const scoreClass = p.score >= 0 ? 'total-positive' : 'total-negative';
    message += `${i+1}. ${p.name}: <span class="${scoreClass}">${p.score}</span><br>`;
  });
  showNotification(message, 'warning');
}

function exportData() {
  let csvContent = "Student Name,Tanbeeh Points,Tashjeeh Points,Total\n";
  points.forEach((p, i) => {
    const name = studentNames[i] || `Student ${i+1}`;
    const total = p.tashjeeh - p.tanbeeh;
    csvContent += `${name},${p.tanbeeh},${p.tashjeeh},${total}\n`;
  });
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tanbeeh-tashjeeh-data-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showNotification("Data exported successfully", "success");
}

function setupEventListeners() {
  addBtn.onclick = () => {
    const studentId = parseInt(studentSelect.value);
    const type = typeSelect.value;
    const itemIdx = parseInt(itemSelect.value);
    const teacher = teacherNameInput.value.trim();
    if (isNaN(studentId)) return showNotification('Please select a student', 'warning');
    if (isNaN(itemIdx)) return showNotification('Please select a reason', 'warning');
    if (!teacher) return showNotification('Please enter your name', 'warning');
    const data = type === 'Tanbeeh' ? tanbeehData : tashjeehData;
    const pts = data[itemIdx].pts;
    const reasonText = data[itemIdx].text;
    if (type === 'Tanbeeh') points[studentId].tanbeeh += pts; else points[studentId].tashjeeh += pts;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
    const now = new Date();
    const timeStr = now.toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    history.push({ time: timeStr, studentId, type, reason: reasonText, points: pts, teacher: teacher.trim() || "Unknown" });
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    renderTable();
    renderHistory();
    updateRecentActivity();
    updateCharts();
    showNotification(`${pts} ${type} points added to ${studentNames[studentId] || 'Student'}`, type === 'Tanbeeh' ? 'warning' : 'success');
    syncToGoogleSheets(studentId, type, pts, reasonText, teacher);
    itemSelect.value = '';
  };

  resetStudentBtn.onclick = () => {
    const idx = parseInt(studentSelect.value);
    if (isNaN(idx)) return showNotification('Select a student first', 'warning');
    if (!confirm(`Reset ${studentNames[idx] || 'Student'} points to zero? (Local only)`)) return;
    points[idx] = {tanbeeh: 0, tashjeeh: 0};
    localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
    renderTable();
    updateCharts();
    showNotification(`${studentNames[idx] || 'Student'} points reset locally`, 'warning');
  };

  clearHistoryBtn.onclick = () => {
    if (history.length === 0) return showNotification('Log is already empty', 'warning');
    if (confirm('Delete ALL local activity log? (Google Sheets history will remain)')) {
      history = [];
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
      updateRecentActivity();
      updateCharts();
      showNotification('Local activity log cleared', 'warning');
    }
  };

  typeSelect.onchange = updateItems;
  syncFromSheetsBtn.onclick = syncFromSheets;
  
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    if (searchTerm.trim() === '') {
      document.querySelectorAll('#pointsTable tbody tr').forEach(row => row.style.display = '');
      return;
    }
    document.querySelectorAll('#pointsTable tbody tr').forEach(row => {
      const studentName = row.cells[2].textContent.toLowerCase();
      const studentNumber = row.cells[1].textContent.toLowerCase();
      if (studentName.includes(searchTerm) || studentNumber.includes(searchTerm)) row.style.display = ''; else row.style.display = 'none';
    });
  });

  document.getElementById('applyBulkAction')?.addEventListener('click', applyBulkAction);
}

function applyBulkAction() {
  if (selectedStudents.size === 0) {
    showNotification('Please select at least one student', 'warning');
    return;
  }
  const actionType = document.getElementById('bulkActionType').value;
  const itemIdx = parseInt(document.getElementById('bulkReason').value);
  const teacher = document.getElementById('bulkTeacherName').value.trim();
  if (isNaN(itemIdx)) return showNotification('Please select a reason', 'warning');
  if (!teacher) return showNotification('Please enter your name', 'warning');
  const data = actionType === 'tanbeeh' ? tanbeehData : tashjeehData;
  const pts = data[itemIdx].pts;
  const reasonText = data[itemIdx].text;
  const type = actionType === 'tanbeeh' ? 'Tanbeeh' : 'Tashjeeh';
  
  selectedStudents.forEach(studentId => {
    if (type === 'Tanbeeh') points[studentId].tanbeeh += pts; else points[studentId].tashjeeh += pts;
    const now = new Date();
    const timeStr = now.toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    history.push({ time: timeStr, studentId, type, reason: reasonText, points: pts, teacher });
    syncToGoogleSheets(studentId, type, pts, reasonText, teacher);
  });
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  renderTable();
  renderHistory();
  updateRecentActivity();
  updateCharts();
  closeModal('bulkActionsModal');
  showNotification(`${type} applied to ${selectedStudents.size} student(s)`, type === 'Tanbeeh' ? 'warning' : 'success');
}

function setupCharts() {
  const pointsTrendCtx = document.getElementById('pointsTrendChart')?.getContext('2d');
  const distributionCtx = document.getElementById('distributionChart')?.getContext('2d');
  const hourlyCtx = document.getElementById('hourlyChart')?.getContext('2d');
  
  if (pointsTrendCtx) {
    charts.pointsTrend = new Chart(pointsTrendCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Tanbeeh', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4, fill: true, borderWidth: 2, pointRadius: 4
          },
          {
            label: 'Tashjeeh', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4, fill: true, borderWidth: 2, pointRadius: 4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: 'white', font: { size: 12 } } },
          tooltip: {
            mode: 'index', intersect: false, backgroundColor: 'rgba(31, 41, 55, 0.9)',
            titleColor: 'white', bodyColor: 'white', borderColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 1
          }
        },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'white', font: { size: 11 } } },
          y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'white', font: { size: 11 } }, beginAtZero: true }
        }
      }
    });
  }
  
  if (distributionCtx) {
    charts.distribution = new Chart(distributionCtx, {
      type: chartType,
      data: {
        labels: ['Tanbeeh', 'Tashjeeh'],
        datasets: [{ data: [0, 0], backgroundColor: ['#ef4444', '#10b981'], borderColor: ['#dc2626', '#059669'], borderWidth: 2 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: 'white', padding: 20, font: { size: 12 } } },
          tooltip: { backgroundColor: 'rgba(31, 41, 55, 0.9)', titleColor: 'white', bodyColor: 'white' }
        }
      }
    });
  }
  
  if (hourlyCtx) {
    charts.hourly = new Chart(hourlyCtx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          { label: 'Tanbeeh', data: [], backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: '#dc2626', borderWidth: 1 },
          { label: 'Tashjeeh', data: [], backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: '#059669', borderWidth: 1 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: 'white', font: { size: 12 } } } },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'white', font: { size: 11 } } },
          y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'white', font: { size: 11 } }, beginAtZero: true }
        }
      }
    });
  }
}

function updateCharts() {
  if (!charts.pointsTrend || !charts.distribution || !charts.hourly) return;
  
  const dateRange = getDateRange(currentTimeRange);
  const filteredHistory = history.filter(log => {
    const logDate = new Date(log.time);
    return logDate >= dateRange.start && logDate <= dateRange.end;
  });
  
  const trendData = aggregateDataByDate(filteredHistory, currentTimeRange);
  charts.pointsTrend.data.labels = trendData.labels;
  charts.pointsTrend.data.datasets[0].data = trendData.tanbeeh;
  charts.pointsTrend.data.datasets[1].data = trendData.tashjeeh;
  charts.pointsTrend.update();
  
  const totalTanbeeh = trendData.tanbeeh.reduce((a, b) => a + b, 0);
  const totalTashjeeh = trendData.tashjeeh.reduce((a, b) => a + b, 0);
  const netChange = totalTashjeeh - totalTanbeeh;
  const avgPerDay = trendData.labels.length > 0 ? ((totalTanbeeh + totalTashjeeh) / trendData.labels.length).toFixed(1) : 0;
  
  document.getElementById('trendTanbeeh').textContent = totalTanbeeh;
  document.getElementById('trendTashjeeh').textContent = totalTashjeeh;
  document.getElementById('trendNet').textContent = netChange;
  document.getElementById('trendNet').style.color = netChange >= 0 ? '#10b981' : '#ef4444';
  document.getElementById('trendAvg').textContent = avgPerDay;
  
  const overallTanbeeh = points.reduce((sum, p) => sum + p.tanbeeh, 0);
  const overallTashjeeh = points.reduce((sum, p) => sum + p.tashjeeh, 0);
  charts.distribution.data.datasets[0].data = [overallTanbeeh, overallTashjeeh];
  charts.distribution.update();
  
  const hourlyData = aggregateDataByHour(filteredHistory);
  charts.hourly.data.labels = hourlyData.labels;
  charts.hourly.data.datasets[0].data = hourlyData.tanbeeh;
  charts.hourly.data.datasets[1].data = hourlyData.tashjeeh;
  charts.hourly.update();
  
  updateTopReasons(filteredHistory);
}

function getDateRange(range) {
  const end = new Date();
  const start = new Date();
  switch(range) {
    case '7d': start.setDate(start.getDate() - 7); break;
    case '30d': start.setDate(start.getDate() - 30); break;
    case '90d': start.setDate(start.getDate() - 90); break;
    case 'all': start.setFullYear(2000); break;
    default: start.setDate(start.getDate() - 7);
  }
  return { start, end };
}

function aggregateDataByDate(historyData, range) {
  const result = { labels: [], tanbeeh: [], tashjeeh: [] };
  const grouped = {};
  
  historyData.forEach(log => {
    const logDate = new Date(log.time);
    let dateKey;
    if (range === '7d') dateKey = logDate.toLocaleDateString('en-GB', { weekday: 'short' });
    else if (range === '30d') dateKey = logDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    else dateKey = `Week ${Math.floor((logDate.getDate() - 1) / 7) + 1}`;
    
    if (!grouped[dateKey]) grouped[dateKey] = { tanbeeh: 0, tashjeeh: 0 };
    if (log.type === 'Tanbeeh') grouped[dateKey].tanbeeh += log.points; else grouped[dateKey].tashjeeh += log.points;
  });
  
  Object.keys(grouped).forEach(key => {
    result.labels.push(key);
    result.tanbeeh.push(grouped[key].tanbeeh);
    result.tashjeeh.push(grouped[key].tashjeeh);
  });
  
  if (result.labels.length === 0) {
    const days = range === '7d' ? 7 : range === '30d' ? 30 : 12;
    for (let i = 0; i < days; i++) {
      const date = new Date();
      if (range === '7d') {
        date.setDate(date.getDate() - (days - 1 - i));
        result.labels.push(date.toLocaleDateString('en-GB', { weekday: 'short' }));
      } else if (range === '30d') {
        date.setDate(date.getDate() - (days - 1 - i));
        result.labels.push(date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
      } else result.labels.push(`Week ${i + 1}`);
      result.tanbeeh.push(0);
      result.tashjeeh.push(0);
    }
  }
  
  return result;
}

function aggregateDataByHour(historyData) {
  const result = { labels: [], tanbeeh: Array(24).fill(0), tashjeeh: Array(24).fill(0) };
  for (let i = 0; i < 24; i++) result.labels.push(`${i}:00`);
  historyData.forEach(log => {
    const logDate = new Date(log.time);
    const hour = logDate.getHours();
    if (log.type === 'Tanbeeh') result.tanbeeh[hour] += log.points; else result.tashjeeh[hour] += log.points;
  });
  return result;
}

function updateTopReasons(historyData) {
  const tanbeehReasons = {}, tashjeehReasons = {};
  historyData.forEach(log => {
    if (log.type === 'Tanbeeh') tanbeehReasons[log.reason] = (tanbeehReasons[log.reason] || 0) + 1;
    else tashjeehReasons[log.reason] = (tashjeehReasons[log.reason] || 0) + 1;
  });
  
  const topTanbeeh = Object.entries(tanbeehReasons).sort((a, b) => b[1] - a[1]).slice(0, 5);
  const topTashjeeh = Object.entries(tashjeehReasons).sort((a, b) => b[1] - a[1]).slice(0, 5);
  
  const tanbeehContainer = document.getElementById('topTanbeehReasons');
  if (tanbeehContainer) {
    if (topTanbeeh.length > 0) {
      tanbeehContainer.innerHTML = topTanbeeh.map(([reason, count], index) => `
        <div style="padding: 10px 12px; margin-bottom: 8px; background: rgba(239,68,68,0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="background: #ef4444; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">${index + 1}</span>
              <span style="color: #fca5a5; font-size: 0.9rem;">${reason.substring(0, 40)}${reason.length > 40 ? '...' : ''}</span>
            </div>
            <span style="background: rgba(239,68,68,0.3); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">${count}</span>
          </div>
        </div>`).join('');
    } else tanbeehContainer.innerHTML = '<div style="color: var(--gray-400); text-align: center; padding: 20px;">No tanbeeh data in selected period</div>';
  }
  
  const tashjeehContainer = document.getElementById('topTashjeehReasons');
  if (tashjeehContainer) {
    if (topTashjeeh.length > 0) {
      tashjeehContainer.innerHTML = topTashjeeh.map(([reason, count], index) => `
        <div style="padding: 10px 12px; margin-bottom: 8px; background: rgba(16,185,129,0.1); border-radius: 8px; border-left: 3px solid #10b981;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="background: #10b981; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">${index + 1}</span>
              <span style="color: #a7f3d0; font-size: 0.9rem;">${reason.substring(0, 40)}${reason.length > 40 ? '...' : ''}</span>
            </div>
            <span style="background: rgba(16,185,129,0.3); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">${count}</span>
          </div>
        </div>`).join('');
    } else tashjeehContainer.innerHTML = '<div style="color: var(--gray-400); text-align: center; padding: 20px;">No tashjeeh data in selected period</div>';
  }
}

function changeTimeRange(range) {
  currentTimeRange = range;
  document.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateCharts();
  let rangeText = '';
  switch(range) { case '7d': rangeText = '7 days'; break; case '30d': rangeText = '30 days'; break; case '90d': rangeText = '90 days'; break; case 'all': rangeText = 'all time'; break; }
  showNotification(`Showing data for ${rangeText}`, 'info');
}

function toggleChartType() {
  chartType = chartType === 'doughnut' ? 'pie' : 'doughnut';
  if (charts.distribution) {
    charts.distribution.destroy();
    const distributionCtx = document.getElementById('distributionChart')?.getContext('2d');
    charts.distribution = new Chart(distributionCtx, {
      type: chartType,
      data: {
        labels: ['Tanbeeh', 'Tashjeeh'],
        datasets: [{ data: [0, 0], backgroundColor: ['#ef4444', '#10b981'], borderColor: ['#dc2626', '#059669'], borderWidth: 2 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: 'white', padding: 20, font: { size: 12 } } },
          tooltip: { backgroundColor: 'rgba(31, 41, 55, 0.9)', titleColor: 'white', bodyColor: 'white' }
        }
      }
    });
    updateCharts();
  }
  showNotification(`Switched to ${chartType} chart`, 'info');
}

function startLiveUpdates() {
  setInterval(() => {
    if (document.getElementById('analyticsTab').classList.contains('active')) {
      updateCharts();
      const indicator = document.getElementById('liveIndicator');
      indicator.style.animation = 'none';
      setTimeout(() => indicator.style.animation = 'pulse 2s infinite', 10);
    }
  }, 30000);
}
</script>
</body>
</html>
